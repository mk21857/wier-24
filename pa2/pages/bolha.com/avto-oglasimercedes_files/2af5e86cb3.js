import{u as e,q as t}from"./a20b5a7092.js";import{F as s,S as i}from"./825e28468d.js";import{debounce as l}from"./4ea6aa4332.js";import{S as r}from"./3c067f2405.js";import o from"./e5795dfffe.js";import"./7abd8ddb57.js";import{s as a}from"./de2ef5ef52.js";import{a as n}from"./bf72b816f7.js";import{t as c}from"./7c6ae762e4.js";import"./2be7671a02.js";import"./f141f5a29b.js";import"./eae60494e1.js";class h extends s{static el=".MultipleOptionHierarchySelector";static childrenEl={"select[]":".MultipleOptionHierarchySelector-select"};constructor(e){if(super(e),null!==this.$el){this.selectors={},this.store={},this.initialStateResolved=!1,this.levelKeyMap=Object.assign({},Object.keys(this.props.levelMap)),this.initialValues=Object.assign({},this.props.initialValues),this.updateLevel=l(500,(e=>{const t=this.getChildKey(e);t&&(this.disableChildren(t),this.fetchLevel(t)),this.initialStateResolved&&"maxValuesCount"in this.props&&this.checkMaxValuesCount()}));const e=e=>e.hasAttribute("data-count")?`${e.textContent} <span class="selectr-item-count">${e.dataset.count}</span>`:e.textContent;this.selectrOptions={placeholder:c("ad_browse.multiple_option_hierarchy_selector.choose"),messages:{noResults:c("ad_browse.multiple_option_hierarchy_selector.no_results"),noOptions:"---"}},this.props.initialCountValues&&(this.selectrOptions.renderOption=e,this.selectrOptions.renderSelection=e),this.$targetInput=document.querySelector(`#${this.props.elementTargetId}`),Object.keys(this.props.levelMap).forEach((e=>{const t=this.$select[this.props.levelMap[e]];null!==t&&(t.innerHTML=""),this.store[e]=new i,this.selectors[e]=new r(t,this.selectrOptions),this.selectors[e].disable(),this.setupEvents(e),this.modifySelectrBehaviour(e)})),this.fetchLevel(this.levelKeyMap[0])}}modifySelectrBehaviour(e){const t=this.selectors[e];t.on("selectr.init",(function(){t.selected.removeAttribute("tabindex"),t.inputClear.addEventListener("click",(function(e){t.open()})),t.input.addEventListener("keydown",(function(e){9===e.keyCode&&t.close()})),0===t.options.length&&t.container.classList.add("selectr-disabled"),a(t.selected,`${t.el?.dataset?.qa??""}.selected`)})),t.on("selectr.open",(function(){let e;t.options.forEach(((s,i)=>{e??=s?.closest("select")?.dataset?.qa??"",a(t.items[i],`${e}.${s.value}`)}))}))}setupEvents(e){const t=this.selectors[e];t.on("selectr.select",(t=>{const s=this.getSelectedValues(e);this.props.groupSelect&&this.props.groupSelect.target===t.value?this.groupSelect(e):(s.indexOf(t.value)<0&&s.push(t.value),this.saveCurrentState(),this.updateLevel(e),this.checkGroupSelectStatus(e))})),t.on("selectr.deselect",(t=>{const s=this.getSelectedValues(e);this.props.groupSelect&&this.props.groupSelect.target===t.value?this.groupDeselect(e):(s.splice(s.indexOf(t.value),1),this.removeChildFromTree(e,t.value),this.saveCurrentState(),this.updateLevel(e),this.checkGroupSelectStatus(e))})),this.addSideEffect((()=>{const t=this.$select[this.props.levelMap[e]],s=e=>{e.stopPropagation()};return t?.addEventListener("touchstart",s,!1),null!==t&&(t.dispatchEvent=()=>{}),()=>{t?.removeEventListener("touchstart",s,!1),null!==t&&delete t.dispatchEvent}}),`selectTouchstart${e}`)}destroyEvents(e){this.selectors[e].off("selectr.select"),this.selectors[e].off("selectr.deselect"),this.removeSideEffect(`selectTouchstart${e}`)}async fetchLevel(e){const t=this.getParentKey(e),s=this.getChildKey(e),i=t&&this.getSelectedValues(t).length||0===this.props.levelMap[e],l=()=>{0!==this.selectors[e].options.length?this.selectors[e].enable():this.selectors[e].disable(),s?this.fetchLevel(s):(this.initialStateResolved=!0,this.saveCurrentState())};try{let t={data:[]};i&&(t=await this.fetchData(e)),this.store[e].reset(),this.store[e].sync(t),this.populateSelect(e),this.selectors[e].destroy(),this.selectors[e].render(this.selectrOptions),l()}catch{l()}}async fetchData(t){const s=e.parse(this.initialValues[t].url),i=this.generateUrlQuery(s,t),l=await o({url:e.format({pathname:s.pathname,query:i})});return 0!==l.data.length&&(this.initialValues[t].type=l.data[0].type),l.included&&delete l.included,l}appendOption(e,t,s){this.getSelectedValues(t);const i=document.createElement("option");i.value=s.value,i.text=s.text,i.selected=s.selected,s.count&&(i.dataset.count=s.count),s.selected&&i.setAttribute("selected","selected"),e.appendChild(i)}populateSelect(e){const t=this.generateData(e),s=this.$select[this.props.levelMap[e]];null!==s&&(s.innerHTML=""),s?.classList.remove("hidden"),t.forEach((t=>{if(t.children){const i=document.createElement("optgroup");i.label=t.text,t.children.forEach((t=>this.appendOption(i,e,t))),s?.appendChild(i)}else this.appendOption(s,e,t)}))}generateUrlQuery(e,s){const i=this.getFilter(s),l=t.parse(e.query);return i.name&&(l[`filter[${i.name}]`]=this.getSelectedValues(i.field).join(",")),l}generateData(e){const t=this.store[e].findAll(this.getLevelType(e));if(0!==t.length){const s=this.getParentKey(e),i=this.getFilter(e),l=this.getSelectedValues(e),r=this.props.initialCountValues,o=e=>0!==l.length&&l.indexOf(e)>-1;return i.field&&i.field===s?this.getSelectedValues(s).map((t=>{const l=this.store[s].find(this.getLevelType(s),t),r=this.store[e].findAll(this.getLevelType(e)).filter((e=>e[i.name]&&e[i.name].id===l.id)).map((e=>({value:e.id,text:e.title,selected:o(e.id)})));return 0!==r.length?{text:l.title,children:r}:null})).filter((e=>null!==e)).sort(((e,t)=>e.text.toLowerCase().localeCompare(t.text.toLowerCase()))):(r&&t.forEach((e=>{const t=r.find((t=>t.locationId===parseInt(e.id,10)));t&&(e.initialCount=t.count)})),t.filter((e=>Boolean(e.title))).map((e=>({value:e.id,text:e.title,count:e.initialCount,selected:o(e.id)}))))}return[]}remove(...e){Object.keys(this.props.levelMap).forEach((e=>{this.store[e].reset(),this.destroyEvents(e),this.selectors[e].destroy()})),super.remove(...e),this.removeElement()}disableChildren(e){const t=this.getChildKey(e);this.selectors[e].disable(),t&&this.disableChildren(t)}removeChildFromTree(e,t){const s=this.getChildKey(e);s&&(this.initialValues[s].selectedValues=this.getSelectedValues(s).filter((t=>{const i=this.getFilter(s),l=this.store[s].find(this.getLevelType(s),t)[i.name];return l&&this.getSelectedValues(e).indexOf(l.id)>-1})),this.removeChildFromTree(s,parent.id))}saveCurrentState(){const e=Object.keys(this.props.levelMap).reduce(((e,t)=>{const s=this.getSelectedValues(t),i=this.getFilter(t);return i.name&&s.forEach((s=>{const l=this.store[t].find(this.getLevelType(t),s);if(l){const t=l[i.name].id,s=e.indexOf(t);s>-1&&(e[s]=null)}})),e.concat(s)}),[]).filter((e=>null!==e)).join(",");null!==(this.$targetInput??null)&&(this.$targetInput.value=e)}checkGroupSelectStatus(e){if(this.props.groupSelect){const t=this.getSelectedValues(e),s=this.props.groupSelect.values.slice().reduce(((e,s)=>!(t.indexOf(s)<0)&&e),!0);this.groupSelectSilentUpdate||(s?this.groupTargetSelect(e):this.groupTargetDeselect(e))}}groupSelect(e){if(this.groupSelectSilentUpdate)this.groupSelectSilentUpdate=!1;else{const t=this.getSelectedValues(e),s=this.props.groupSelect.values.slice();this.selectors[e].setValue(s.filter((e=>t.indexOf(e)<0)))}}groupDeselect(e){if(this.groupSelectSilentUpdate)this.groupSelectSilentUpdate=!1;else{const t=this.getSelectedValues(e),s=this.props.groupSelect.values.slice();this.selectors[e].setValue(s.filter((e=>t.indexOf(e)>-1)))}}groupTargetSelect(e){this.selectors[e].getValue().indexOf(this.props.groupSelect.target)<0&&(this.groupSelectSilentUpdate=!0,setTimeout((()=>{this.selectors[e].setValue(this.props.groupSelect.target)}),0))}groupTargetDeselect(e){this.selectors[e].getValue().indexOf(this.props.groupSelect.target)>-1&&(this.groupSelectSilentUpdate=!0,this.selectors[e].setValue(this.props.groupSelect.target))}async checkMaxValuesCount(){const e=this.$targetInput?.value.split(",");this.maxValuesCountAmountMemo=this.maxValuesCountAmountMemo||0,e.length>this.props.maxValuesCount.amount&&e.length>this.maxValuesCountAmountMemo&&(this.maxValuesCountAmountMemo=e.length,await n(this.props.maxValuesCount.message))}getLevelType(e){return this.initialValues[e].type}getFilter(e){return this.initialValues[e].filters[0]||{}}getSelectedValues(e){return this.initialValues[e].selectedValues}getChildKey(e){return this.levelKeyMap[this.props.levelMap[e]+1]}getParentKey(e){return this.levelKeyMap[this.props.levelMap[e]-1]}}export{h as default};
