import{F as e,l as t,S as s,i as l,M as a}from"./825e28468d.js";import i from"./e5795dfffe.js";import{i as r,t as n}from"./510f0914a3.js";import{t as o}from"./ac447121df.js";import"./2be7671a02.js";import"./f141f5a29b.js";import"./a20b5a7092.js";import"./eae60494e1.js";class h extends e{static el=".HierarchySelector";static childrenEl={"item[]":".HierarchySelector-item","label[]":".HierarchySelector-label","select[]":".HierarchySelector-select"};static events={async"change .HierarchySelector-select"(e){const s=e.target,l=this.processTargetId(s.value),a=this.getLevelFromSelectElementId(s.id);try{await this.getCategory(l,a),this.silentChange?this.silentChange=!1:null!==this.focusOnElement?this.focusElement(this.focusOnElement):this.focusElement(e.target)}catch(i){t()}}};static defaultProps={fetchInitialData:!1};constructor(e){super(e),null!==this.$el&&(this.placeholderCaption={...this.props.placeholderCaption},this.levelState={},this.valueChangedStore=new s,this.optionsStore=new s,this.setMaxLevel(this.props.maxLevel),this.$targetId=null,this.props.elementTargetId&&(this.$targetId=document.querySelector(`#${this.props.elementTargetId}`)),this.setupEvents(),this.props.fetchInitialData&&this.fetchInitialData())}setupEvents(){}processTargetId(e){const t=parseInt(e,10);return""===e?0:r(t)?t:e}setLevelState(e,t){this.levelState={...this.levelState,[e]:t}}getLevelState(){return this.levelState}setTargetIdVal(e){null!==(this.$targetId??null)&&(this.$targetId.value=e)}getTargetIdVal(){return this.processTargetId(this.$targetId?.value??"")}setPlaceholderCaption(e){this.placeholderCaption=e}setMaxLevel(e){this.setState({maxLevel:parseInt(e,10)})}getMaxLevel(){return this.state.maxLevel}getUrlAlias(e){return this.$("option",!0).filter((t=>this.processTargetId(t.value)===e)).map((e=>e.getAttribute("data-url-alias"))).join("")}publishChangedCategoryEvent(e,t){this.props.elementTargetId&&l.publish("categorySelectorValueChanged",[this.props.elementTargetId,e,{urlAlias:this.getUrlAlias(e),level:t}])}async getCategory(e,t){const s=this.getMaxLevel(),l=this.haveCategoryId(e),a=t+(l?1:0),i=this.getLevelState(),r=this.processTargetId(l||0===t?e:i[t-1]),n={categoryId:r,level:parseInt(t,10),nextLevel:parseInt(a,10)};return l?(this.focusOnElement=null,t<s?this.fetchNextCategory(n):this.lastCategorySelected(n)):(this.onPlaceholderSelected(r),void this.processSelectRangeState(t+1,s,n))}processSelectRangeState(e,t,s){let l;for(l=e;l<=t;l++){const e=[this.getPlaceholder(l)].map((e=>({value:parseInt(e.id,10),text:e.attributes.label})));this.processSingleSelectState(l),this.populateElement(l,e)}}processSingleSelectState(e){const t=this.getSelectElementFromLevel(e);null!==t&&(t.disabled=!0)}populateElement(e,t){let s=0;const l=t.reduce(((e,t)=>{const l=void 0!==t.group;l&&s++;const a=l?t.group:`default${s}`;return e[a]=e[a]||[],e[a].push(t),e}),{});this.populateOptionsForLevel(e,l)}enableLoadingState(){this.setState({loading:!0})}disableLoadingState(){this.setState({loading:!1})}getPlaceholder(e){return{id:0,type:"placeholderChoice",attributes:{label:this.placeholderCaption[e]||this.props?.valueChangedInitialValues?.placeholderCaption?.[e]||"---"}}}parseFetchResponse(e){return{data:e,isEmpty:0===e.data.length}}getPreparedElementCollection(e){const t=[].concat(e.findAll("placeholderChoice"),e.findAll("locationChoice"),e.findAll("choice"));let s=t;if(!this.initialStateResolved){const e=Object.keys(this.props.initialValues).map((e=>this.props.initialValues[e])).filter((e=>0!==e));s=[].concat(t).map((t=>(t.selected=!1,-1!==e.indexOf(parseInt(t.id,10))&&(t.selected=!0),t)))}return[].concat(s).map((e=>{const t="string"==typeof e.shortName,s=Boolean(e.groups);let l={},a={};return t&&(l={"data-url-alias":`/${e.shortName}`}),s&&(a={group:e.groups.groupName}),{value:parseInt(e.id,10),text:e.label,attributes:{selected:Boolean(e.selected),...l},...a}}))}haveCategoryId(e){return"0"!==e&&""!==e&&0!==e}async fetchInitialData(){const e=await Object.keys(this.props.initialValues).map(((e,t,s)=>{let l,a,i=!1;0===t?(l=null,a=t):(l=t-1,a=t,a>=s.length-1&&(a=null,i=!0));const r=this.props.initialValues[e];return()=>{const e={categoryId:r,level:l,nextLevel:a};return i?this.lastCategorySelected(e):this.fetchNextCategory(e)}})).reduce(((e,t)=>e.then(t)),Promise.resolve());return this.initialStateResolved=!0,e}getLevelFromSelectElementId(e){return this.props.levelMap[e]}getSelectElementFromLevel(e){const t=`$selectLevel${e}`,s=Object.keys(this.props.levelMap).filter((t=>this.props.levelMap[t]===e)).join("");return void 0===this[t]&&(this[t]=s?this.$select.find((e=>e.id===s))??null:null),this[t]}syncOptions(e,t){return this.optionsStore.reset(),this.optionsStore.sync({data:this.getPlaceholder(t)}),this.optionsStore.sync(e),this.optionsStore}syncValueChanged(e){const t=this.props.valueChangedInitialValues;return this.valueChangedStore.findAll("changed-form-element-property").forEach((e=>{e.setAttribute("changedAttributeValue",t[e.changedAttribute])})),this.valueChangedStore.sync(e),this.valueChangedStore}renderValueChanged(){this.valueChangedStore.findAll("changed-form-element-property").forEach((({changedAttribute:e,changedAttributeValue:t})=>{if("labels"===e&&this.updateLabels(t),"maxLevel"===e){const e=t-1;this.setMaxLevel(e)}"placeholderCaption"===e&&this.setPlaceholderCaption(t)}))}async fetchNextCategory(e){const{categoryId:t,level:s}=e;this.props.elementTargetId&&l.publish("categorySelectorFetching",[this.props.elementTargetId,t,s]),this.enableLoadingState();let r=Promise.resolve({data:{}});if(this.props.valueChangedUrl){const e=new a("form-change");e.setAttribute(this.props.elementName,t);const s=e.serialize();r=i({type:"post",url:this.props.valueChangedUrl,data:s})}const[o,h]=await Promise.all([i({url:n(this.props.url,{id:t})}),r]);return this.syncValueChanged(h),this.renderValueChanged(),this.disableLoadingState(),this.onFetchNextCategory(o,e),o}async lastCategorySelected(e){this.onLastCategorySelected(e)}onLastCategorySelected(e){const{level:t,categoryId:s}=e;null!==t&&(this.setLevelState(t,s),this.haveCategoryId(s)&&(this.setTargetIdVal(s),this.publishChangedCategoryEvent(s,t)))}onFetchNextCategory(e,t){const s=this.parseFetchResponse(e),a=this.getMaxLevel(),i=Boolean(s.isEmpty),{level:r,nextLevel:n,categoryId:h}=t,c=this.syncOptions(e,n);this.populateElement(n,this.getPreparedElementCollection(c));const p=this.getSelectElementFromLevel(n);if(null!==p&&(p.disabled=i),this.processSelectRangeState(n+1,a,t),null!==r&&(this.setLevelState(r,h),this.haveCategoryId(h)&&(this.setTargetIdVal(h),this.publishChangedCategoryEvent(h,r))),this.focusOnElement=null,this.props.selectLastLevelWithOnlyOneOption&&n===a&&this.categoryHasOneOption(c)&&!i){const e=this.getCategoryOnlyOption(c);if(null!==e){const t=this.processTargetId(e.id);this.lastCategorySelected({level:n,categoryId:t}),null!==p&&(p.value=t),void 0===this.canEmit||this.initialStateResolved||(this.canEmit=!1),this.silentChange=!0,o(p,"change"),this.focusOnElement=p}}this.props.elementTargetId&&l.publish("categorySelectorFetched",[this.props.elementTargetId,h,r])}onPlaceholderSelected(e){const t=e??0;this.setTargetIdVal(t),this.publishChangedCategoryEvent(t)}categoryHasOneOption(e){return 1===[].concat(e.findAll("locationChoice"),e.findAll("choice")).length}getCategoryOnlyOption(e){const t=[].concat(e.findAll("locationChoice"),e.findAll("choice"));return 1===t.length?t[0]:null}focusElement(e){e.focus()}render(e,t){"loading"===e&&this.$select.forEach((e=>{e.disabled=t})),"maxLevel"===e&&this.$item.forEach(((e,s)=>{e.classList.remove("hidden"),s>t&&e.classList.add("hidden")}))}populateOptionsForLevel(e,t){const s=this.getSelectElementFromLevel(e),l=Object.keys(t).map((e=>-1!==e.indexOf("default")?t[e].map((e=>this.createOptionElement(e))):this.createOptionGroup(e,t[e]))).reduce(((e,t)=>e.concat(t)),[]);null!==s&&(s.innerHTML="",l.forEach((e=>{s.append(e)})))}createOptionElement(e){const t=document.createElement("option");return t.value=e.value,t.textContent=e.text,Object.entries(e.attributes??{}).forEach((([e,s])=>{["selected","disabled"].includes(e)?t[e]=s:t.setAttribute(e,s)})),t}createOptionGroup(e,t){if(""===e||0===t.length)return null;const s=document.createElement("optgroup");s.setAttribute("label",e);const l=document.createDocumentFragment();return t.map((e=>this.createOptionElement(e))).forEach((e=>{l.appendChild(e)})),s.append(l),s}updateLabels(e){e.forEach(((e,t)=>{const s=this.$label[t]??null,l=this.props.columnized&&""===e?"&nbsp;":e;null!==s&&(s.classList.remove("vis-hidden"),s.classList.remove("form-label--faux-label"),s.removeAttribute("role"),s.removeAttribute("aria-hidden"),this.props.columnized||""!==e||s.classList.add("vis-hidden"),this.props.columnized&&""===e&&(s.classList.add("form-label--faux-label"),s.setAttribute("role","presentation"),s.setAttribute("aria-hidden","true")),s.innerHTML=l)}))}}export{h as default};
